<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pivnica</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 40px;
    }

    h1 {
      color: #333;
    }

    .value {
      display: inline-block;
      margin: 10px;
    }

    .value p {
      font-size: 24px;
    }

    .value button {
      font-size: 18px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Pivnica</h1>
  <div class="value">
    <p id="adram">0</p>
    <p>Adram</p>
    <button onclick="increaseValue('adram')">+1</button>
    <button onclick="decreaseValue('adram')">-10</button>
  </div>
  <div class="value">
    <p id="active">0</p>
    <p>Active</p>
    <button onclick="increaseValue('active')">+1</button>
    <button onclick="decreaseValue('active')">-10</button>
  </div>
  <div class="value">
    <p id="reaver">0</p>
    <p>Reaver</p>
    <button onclick="increaseValue('reaver')">+1</button>
    <button onclick="decreaseValue('reaver')">-10</button>
  </div>
  <div class="value">
    <p id="falco">0</p>
    <p>Falco</p>
    <button onclick="increaseValue('falco')">+1</button>
    <button onclick="decreaseValue('falco')">-10</button>
  </div>

  <script>
    // GitHub repository details
    const username = 'lowlune';
    const repo = 'pivnica';
    const filename = 'values.json';
    const clientId = '57f3150eae66953b1d40';
    const redirectUri = 'https://lowlune.github.io/pivnica/';

    // Values state
    let values = {
      adram: 0,
      active: 0,
      reaver: 0,
      falco: 0
    };

    // Helper function to update the display
    function updateDisplay() {
      for (const key in values) {
        const element = document.getElementById(key);
        if (element) {
          element.textContent = values[key];
        }
      }
    }

    // Function to handle OAuth login
    function login() {
      // Redirect the user to the GitHub OAuth login page
      window.location.href = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}`;
    }

    // Function to handle the OAuth callback after successful login
    async function handleCallback() {
      // Parse the access token from the URL hash
      const params = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = params.get('access_token');

      if (accessToken) {
        // Store the access token in local storage or a secure storage mechanism
        // This example uses local storage for simplicity
        localStorage.setItem('githubAccessToken', accessToken);

        // Retrieve the values from GitHub API
        await getValuesFromGitHub();
      } else {
        console.log('Access token not found');
      }
    }

    // Function to fetch the values from GitHub API
    async function getValuesFromGitHub() {
      try {
        // Fetch the file contents from GitHub API
        const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('githubAccessToken')}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (response.ok) {
          // Parse the file contents
          const data = await response.json();

          if (data && data.content) {
            // Decode and parse the file content as JSON
            const content = atob(data.content);
            values = JSON.parse(content);
            updateDisplay();
          }
        } else {
          console.log('Failed to fetch values from GitHub', response.status);
        }
      } catch (error) {
        console.log('Error occurred while fetching values', error);
      }
    }

    // Function to save the values to GitHub API
    async function saveValuesToGitHub() {
      try {
        // Encode the values as JSON and convert it to base64
        const content = btoa(JSON.stringify(values));

        // Fetch the file details from GitHub API
        const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('githubAccessToken')}`,
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify({
            message: 'Update values',
            content: content,
            sha: values.sha || null
          })
        });

        if (response.ok) {
          // Parse the response to get the updated file details
          const data = await response.json();

          if (data && data.content) {
            values.sha = data.content.sha;
            console.log('Values saved to GitHub');
          }
        } else {
          console.log('Failed to save values to GitHub', response.status);
        }
      } catch (error) {
        console.log('Error occurred while saving values', error);
      }
    }

    // Function to increase a value
    function increaseValue(key) {
      values[key] += 1;
      updateDisplay();
      saveValuesToGitHub();
    }

    // Function to decrease a value
    function decreaseValue(key) {
      values[key] -= 10;
      updateDisplay();
      saveValuesToGitHub();
    }

    // Check if the access token is already available in local storage
    const accessToken = localStorage.getItem('githubAccessToken');
    if (accessToken) {
      // Access token found, retrieve the values from GitHub API
      getValuesFromGitHub();
    } else {
      // Access token not found, show the login button
      const loginButton = document.createElement('button');
      loginButton.textContent = 'Login with GitHub';
      loginButton.onclick = login;
      document.body.appendChild(loginButton);
    }

    // Check if the page is loaded after the OAuth callback
    if (window.location.href.includes(redirectUri)) {
      handleCallback();
    }
  </script>
</body>
</html>
